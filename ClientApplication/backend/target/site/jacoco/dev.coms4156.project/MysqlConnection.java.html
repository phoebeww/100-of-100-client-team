<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MysqlConnection.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">backend</a> &gt; <a href="index.source.html" class="el_package">dev.coms4156.project</a> &gt; <span class="el_source">MysqlConnection.java</span></div><h1>MysqlConnection.java</h1><pre class="source lang-java linenums">package dev.coms4156.project;

import dev.coms4156.project.exception.InternalServerErrorException;

import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.List;

/**
 * A singleton class of database connection.
 * This class is responsible for creating and managing the connection to the database.
 * Designed under the Singleton Design Pattern.
 */
public class MysqlConnection implements DatabaseConnection {
  private static volatile MysqlConnection instance;
  private Connection connection;

  @Override
  public String connectionName() {
<span class="fc" id="L24">    return &quot;MysqlConnection::us-east-1.rds.amazonaws.com&quot;;</span>
  }

<span class="fc" id="L27">  private MysqlConnection() {</span>
    try {
<span class="fc" id="L29">      String url = &quot;jdbc:mysql://new-db.c3uqsummqbeu.us-east-1.rds.amazonaws.com:3306/&quot;</span>
              + &quot;organization_management&quot;;
<span class="fc" id="L31">      String user = &quot;admin&quot;;</span>
<span class="fc" id="L32">      String password = &quot;12345678&quot;;</span>
<span class="fc" id="L33">      this.connection = DriverManager.getConnection(url, user, password);</span>
<span class="nc" id="L34">    } catch (SQLException e) {</span>
<span class="nc" id="L35">      e.printStackTrace();</span>
<span class="nc" id="L36">      throw new InternalServerErrorException(&quot;Failed to connect to the database.&quot;);</span>
<span class="fc" id="L37">    }</span>
<span class="fc" id="L38">  }</span>

  /**
   * Returns an employee in a given organization by external ID.
   *
   * @param organizationId the organization id (clientId)
   * @param externalEmployeeId the external employee id
   * @return the employee if found, null otherwise
   */
  @Override
  public Employee getEmployee(int organizationId, int externalEmployeeId) {
<span class="fc" id="L49">    int internalEmployeeId = organizationId * 10000 + externalEmployeeId;</span>
<span class="fc" id="L50">    String query = &quot;SELECT * FROM employees WHERE organization_id = ? AND employee_id = ?&quot;;</span>
<span class="fc" id="L51">    try (PreparedStatement pstmt = connection.prepareStatement(query)) {</span>
<span class="fc" id="L52">      pstmt.setInt(1, organizationId);</span>
<span class="fc" id="L53">      pstmt.setInt(2, internalEmployeeId);</span>
<span class="fc" id="L54">      ResultSet rs = pstmt.executeQuery();</span>
<span class="pc bpc" id="L55" title="1 of 2 branches missed.">      if (rs.next()) {</span>
<span class="fc" id="L56">        Employee employee = new Employee(</span>
                externalEmployeeId,
<span class="fc" id="L58">                rs.getString(&quot;name&quot;),</span>
<span class="fc" id="L59">                rs.getDate(&quot;hire_date&quot;)</span>
        );
        // Set additional employee information
<span class="fc" id="L62">        employee.setPosition(rs.getString(&quot;position&quot;));</span>
<span class="fc" id="L63">        employee.setSalary(rs.getDouble(&quot;salary&quot;));</span>
<span class="fc" id="L64">        employee.setPerformance(rs.getDouble(&quot;performance&quot;));</span>
<span class="fc" id="L65">        return employee;</span>
      }
<span class="pc bpc" id="L67" title="1 of 2 branches missed.">    } catch (SQLException e) {</span>
<span class="nc" id="L68">      e.printStackTrace();</span>
<span class="nc" id="L69">    }</span>
<span class="nc" id="L70">    return null;</span>
  }

  /**
   * Returns a department in a given organization by external ID.
   *
   * @param organizationId the organization id (clientId)
   * @param externalDepartmentId the external department id
   * @return the department if found, null otherwise
   */
  @Override
  public Department getDepartment(int organizationId, int externalDepartmentId) {
<span class="nc" id="L82">    int internalDepartmentId = organizationId * 10000 + externalDepartmentId;</span>
<span class="nc" id="L83">    String query = &quot;SELECT * FROM departments WHERE organization_id = ? AND department_id = ?&quot;;</span>
<span class="nc" id="L84">    try (PreparedStatement pstmt = connection.prepareStatement(query)) {</span>
<span class="nc" id="L85">      pstmt.setInt(1, organizationId);</span>
<span class="nc" id="L86">      pstmt.setInt(2, internalDepartmentId);</span>
<span class="nc" id="L87">      ResultSet rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L88" title="All 2 branches missed.">      if (rs.next()) {</span>
<span class="nc" id="L89">        List&lt;Employee&gt; employees = getEmployeesForDepartment(internalDepartmentId, organizationId);</span>
<span class="nc" id="L90">        return new Department(</span>
                externalDepartmentId,
<span class="nc" id="L92">                rs.getString(&quot;name&quot;),</span>
                employees
        );
      }
<span class="nc bnc" id="L96" title="All 2 branches missed.">    } catch (SQLException e) {</span>
<span class="nc" id="L97">      e.printStackTrace();</span>
<span class="nc" id="L98">    }</span>
<span class="nc" id="L99">    return null;</span>
  }

  /**
   * Returns a list of employees in a given organization.
   *
   * @param organizationId the organization id
   * @return a list of employees in the organization
   */
  @Override
  public List&lt;Employee&gt; getEmployees(int organizationId) {
<span class="fc" id="L110">    List&lt;Employee&gt; employees = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L111">    String query = &quot;SELECT * FROM employees WHERE organization_id = ?&quot;;</span>
<span class="fc" id="L112">    try (PreparedStatement pstmt = connection.prepareStatement(query)) {</span>
<span class="fc" id="L113">      pstmt.setInt(1, organizationId);</span>
<span class="fc" id="L114">      ResultSet rs = pstmt.executeQuery();</span>
<span class="fc bfc" id="L115" title="All 2 branches covered.">      while (rs.next()) {</span>
<span class="fc" id="L116">        int internalId = rs.getInt(&quot;employee_id&quot;);</span>
<span class="fc" id="L117">        int externalId = internalId % 10000;</span>
<span class="fc" id="L118">        Employee employee = new Employee(</span>
                externalId,
<span class="fc" id="L120">                rs.getString(&quot;name&quot;),</span>
<span class="fc" id="L121">                rs.getDate(&quot;hire_date&quot;)</span>
        );
        // Set additional employee information
<span class="fc" id="L124">        employee.setPosition(rs.getString(&quot;position&quot;));</span>
<span class="fc" id="L125">        employee.setSalary(rs.getDouble(&quot;salary&quot;));</span>
<span class="fc" id="L126">        employee.setPerformance(rs.getDouble(&quot;performance&quot;));</span>
<span class="fc" id="L127">        employees.add(employee);</span>
<span class="fc" id="L128">      }</span>
<span class="nc" id="L129">    } catch (SQLException e) {</span>
<span class="nc" id="L130">      e.printStackTrace();</span>
<span class="fc" id="L131">    }</span>
<span class="fc" id="L132">    return employees;</span>
  }

  /**
   * Returns a list of departments in a given organization.
   *
   * @param organizationId the organization id
   * @return a list of departments in the organization
   */
  @Override
  public List&lt;Department&gt; getDepartments(int organizationId) {
<span class="fc" id="L143">    List&lt;Department&gt; departments = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L144">    String query = &quot;SELECT * FROM departments WHERE organization_id = ?&quot;;</span>
<span class="fc" id="L145">    try (PreparedStatement pstmt = connection.prepareStatement(query)) {</span>
<span class="fc" id="L146">      pstmt.setInt(1, organizationId);</span>
<span class="fc" id="L147">      ResultSet rs = pstmt.executeQuery();</span>
<span class="fc bfc" id="L148" title="All 2 branches covered.">      while (rs.next()) {</span>
<span class="fc" id="L149">        int internalId = rs.getInt(&quot;department_id&quot;);</span>
<span class="fc" id="L150">        int externalId = internalId % 10000;</span>
<span class="fc" id="L151">        List&lt;Employee&gt; employees = getEmployeesForDepartment(internalId, organizationId);</span>
<span class="fc" id="L152">        Department department = new Department(</span>
                externalId,
<span class="fc" id="L154">                rs.getString(&quot;name&quot;),</span>
                employees
        );

        // Get and set head if exists
<span class="fc" id="L159">        Integer headEmployeeId = rs.getInt(&quot;head_employee_id&quot;);</span>
<span class="pc bpc" id="L160" title="1 of 2 branches missed.">        if (!rs.wasNull()) {</span>
<span class="fc" id="L161">          Employee head = getEmployee(organizationId, headEmployeeId % 10000);</span>
<span class="pc bpc" id="L162" title="1 of 2 branches missed.">          if (head != null) {</span>
<span class="fc" id="L163">            department.setHead(head);</span>
          }
        }

<span class="fc" id="L167">        departments.add(department);</span>
<span class="fc" id="L168">      }</span>
<span class="nc" id="L169">    } catch (SQLException e) {</span>
<span class="nc" id="L170">      e.printStackTrace();</span>
<span class="fc" id="L171">    }</span>
<span class="fc" id="L172">    return departments;</span>
  }

  /**
   * Returns an organization with the given organization id.
   *
   * @param organizationId the organization id
   * @return the organization with the given organization id
   */
  @Override
  public Organization getOrganization(int organizationId) {
<span class="fc" id="L183">    String query = &quot;SELECT * FROM organizations WHERE organization_id = ?&quot;;</span>
<span class="fc" id="L184">    try (PreparedStatement pstmt = connection.prepareStatement(query)) {</span>
<span class="fc" id="L185">      pstmt.setInt(1, organizationId);</span>
<span class="fc" id="L186">      ResultSet rs = pstmt.executeQuery();</span>
<span class="fc bfc" id="L187" title="All 2 branches covered.">      if (rs.next()) {</span>
<span class="fc" id="L188">        return new Organization(</span>
<span class="fc" id="L189">                rs.getInt(&quot;organization_id&quot;),</span>
<span class="fc" id="L190">                rs.getString(&quot;name&quot;)</span>
        );
      }
<span class="pc bpc" id="L193" title="1 of 2 branches missed.">    } catch (SQLException e) {</span>
<span class="nc" id="L194">      e.printStackTrace();</span>
<span class="fc" id="L195">    }</span>
<span class="fc" id="L196">    return null;</span>
  }

  /**
   * Returns a list of employees in a given department.
   *
   * @param internalDepartmentId the internal department id
   * @param organizationId the organization id
   * @return a list of employees in the department
   */
  private List&lt;Employee&gt; getEmployeesForDepartment(int internalDepartmentId, int organizationId) {
<span class="fc" id="L207">    List&lt;Employee&gt; employees = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L208">    String query = &quot;SELECT * FROM employees WHERE department_id = ? AND organization_id = ?&quot;;</span>

<span class="fc" id="L210">    try (PreparedStatement pstmt = connection.prepareStatement(query)) {</span>
<span class="fc" id="L211">      pstmt.setInt(1, internalDepartmentId);</span>
<span class="fc" id="L212">      pstmt.setInt(2, organizationId);</span>
<span class="fc" id="L213">      ResultSet rs = pstmt.executeQuery();</span>

<span class="fc bfc" id="L215" title="All 2 branches covered.">      while (rs.next()) {</span>
<span class="fc" id="L216">        int internalId = rs.getInt(&quot;employee_id&quot;);</span>
<span class="fc" id="L217">        int externalId = internalId % 10000;</span>
<span class="fc" id="L218">        Employee employee = new Employee(</span>
                externalId,
<span class="fc" id="L220">                rs.getString(&quot;name&quot;),</span>
<span class="fc" id="L221">                rs.getDate(&quot;hire_date&quot;)</span>
        );
        // Set additional employee information
<span class="fc" id="L224">        employee.setPosition(rs.getString(&quot;position&quot;));</span>
<span class="fc" id="L225">        employee.setSalary(rs.getDouble(&quot;salary&quot;));</span>
<span class="fc" id="L226">        employee.setPerformance(rs.getDouble(&quot;performance&quot;));</span>
<span class="fc" id="L227">        employees.add(employee);</span>
<span class="fc" id="L228">      }</span>
<span class="nc" id="L229">    } catch (SQLException e) {</span>
<span class="nc" id="L230">      e.printStackTrace();</span>
<span class="fc" id="L231">    }</span>

<span class="fc" id="L233">    return employees;</span>
  }

  /**
   * Adds a new employee to a department in the database.
   *
   * @param organizationId the organization id
   * @param departmentId the internal department id
   * @param employee the employee to add
   * @return the internal employee ID if successful, -1 if failed
   */
  @Override
  public int addEmployeeToDepartment(int organizationId, int departmentId, Employee employee) {
    // First get the next available employee ID for this organization
<span class="nc" id="L247">    String maxIdQuery =</span>
            &quot;SELECT MAX(employee_id) as max_id &quot;
                    + &quot;FROM employees &quot;
                    + &quot;WHERE organization_id = ?&quot;;
    int newEmployeeId;

<span class="nc" id="L253">    try (PreparedStatement pstmt = connection.prepareStatement(maxIdQuery)) {</span>
<span class="nc" id="L254">      pstmt.setInt(1, organizationId);</span>
<span class="nc" id="L255">      ResultSet rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L256" title="All 2 branches missed.">      if (rs.next()) {</span>
<span class="nc" id="L257">        int maxId = rs.getInt(&quot;max_id&quot;);</span>
<span class="nc bnc" id="L258" title="All 2 branches missed.">        if (rs.wasNull()) {</span>
<span class="nc" id="L259">          newEmployeeId = organizationId * 10000 + 1;</span>
        } else {
<span class="nc" id="L261">          newEmployeeId = maxId + 1;</span>
        }
<span class="nc" id="L263">      } else {</span>
<span class="nc" id="L264">        newEmployeeId = organizationId * 10000 + 1;</span>
      }
<span class="nc" id="L266">    } catch (SQLException e) {</span>
<span class="nc" id="L267">      e.printStackTrace();</span>
<span class="nc" id="L268">      return -1;</span>
<span class="nc" id="L269">    }</span>

    // Insert the new employee
<span class="nc" id="L272">    String insertEmployeeQuery =</span>
      &quot;INSERT INTO employees &quot;
        + &quot;(employee_id, organization_id, department_id, name, hire_date, position, salary, performance) &quot;
        + &quot;VALUES (?, ?, ?, ?, ?, ?, ?, ?)&quot;;

<span class="nc" id="L277">    try (PreparedStatement pstmt = connection.prepareStatement(insertEmployeeQuery)) {</span>
<span class="nc" id="L278">      pstmt.setInt(1, newEmployeeId);</span>
<span class="nc" id="L279">      pstmt.setInt(2, organizationId);</span>
<span class="nc" id="L280">      pstmt.setInt(3, departmentId);</span>
<span class="nc" id="L281">      pstmt.setString(4, employee.getName());</span>
<span class="nc" id="L282">      pstmt.setDate(5, new java.sql.Date(employee.getHireDate().getTime()));</span>
<span class="nc" id="L283">      pstmt.setString(6, employee.getPosition());</span>
<span class="nc" id="L284">      pstmt.setDouble(7, employee.getSalary());</span>
<span class="nc" id="L285">      pstmt.setDouble(8, employee.getPerformance());</span>

<span class="nc" id="L287">      int rowsAffected = pstmt.executeUpdate();</span>
<span class="nc bnc" id="L288" title="All 2 branches missed.">      if (rowsAffected &gt; 0) {</span>
<span class="nc" id="L289">        return newEmployeeId;</span>
      }
<span class="nc bnc" id="L291" title="All 2 branches missed.">    } catch (SQLException e) {</span>
<span class="nc" id="L292">      e.printStackTrace();</span>
<span class="nc" id="L293">    }</span>
<span class="nc" id="L294">    return -1;</span>
  }

  /**
   * Removes an employee from a department in the database.
   *
   * @param organizationId the organization id
   * @param departmentId the internal department id
   * @param employeeId the internal employee id
   * @return true if removal successful, false otherwise
   */
  @Override
  public boolean removeEmployeeFromDepartment(int organizationId,
                                              int departmentId, int employeeId) {
<span class="nc" id="L308">    String checkHeadQuery =</span>
            &quot;SELECT head_employee_id FROM departments &quot;
                    + &quot;WHERE department_id = ? AND organization_id = ?&quot;;

<span class="nc" id="L312">    try (PreparedStatement checkStmt = connection.prepareStatement(checkHeadQuery)) {</span>
<span class="nc" id="L313">      checkStmt.setInt(1, departmentId);</span>
<span class="nc" id="L314">      checkStmt.setInt(2, organizationId);</span>

<span class="nc" id="L316">      ResultSet rs = checkStmt.executeQuery();</span>
<span class="nc bnc" id="L317" title="All 4 branches missed.">      if (rs.next() &amp;&amp; rs.getInt(&quot;head_employee_id&quot;) == employeeId) {</span>
<span class="nc" id="L318">        String updateHeadQuery =</span>
                &quot;UPDATE departments SET head_employee_id = NULL &quot;
                        + &quot;WHERE department_id = ? AND organization_id = ?&quot;;
<span class="nc" id="L321">        try (PreparedStatement updateStmt = connection.prepareStatement(updateHeadQuery)) {</span>
<span class="nc" id="L322">          updateStmt.setInt(1, departmentId);</span>
<span class="nc" id="L323">          updateStmt.setInt(2, organizationId);</span>
<span class="nc" id="L324">          updateStmt.executeUpdate();</span>
        }
      }
<span class="nc" id="L327">    } catch (SQLException e) {</span>
<span class="nc" id="L328">      e.printStackTrace();</span>
<span class="nc" id="L329">      return false;</span>
<span class="nc" id="L330">    }</span>

<span class="nc" id="L332">    String deleteQuery =</span>
            &quot;DELETE FROM employees &quot;
                    + &quot;WHERE employee_id = ? AND department_id = ? AND organization_id = ?&quot;;

<span class="nc" id="L336">    try (PreparedStatement pstmt = connection.prepareStatement(deleteQuery)) {</span>
<span class="nc" id="L337">      pstmt.setInt(1, employeeId);</span>
<span class="nc" id="L338">      pstmt.setInt(2, departmentId);</span>
<span class="nc" id="L339">      pstmt.setInt(3, organizationId);</span>

<span class="nc" id="L341">      int rowsAffected = pstmt.executeUpdate();</span>
<span class="nc bnc" id="L342" title="All 2 branches missed.">      return rowsAffected &gt; 0;</span>
<span class="nc" id="L343">    } catch (SQLException e) {</span>
<span class="nc" id="L344">      e.printStackTrace();</span>
<span class="nc" id="L345">      return false;</span>
    }
  }

  @Override
  public boolean updateEmployee(int organizationId, Employee employee) {
<span class="nc" id="L351">    int internalEmployeeId = organizationId * 10000 + employee.getId();</span>
<span class="nc" id="L352">    String query = &quot;UPDATE employees SET name = ?, position = ?, salary = ?, performance = ? &quot;</span>
            + &quot;WHERE organization_id = ? AND employee_id = ?&quot;;

<span class="nc" id="L355">    try (PreparedStatement pstmt = connection.prepareStatement(query)) {</span>
<span class="nc" id="L356">      pstmt.setString(1, employee.getName());</span>
<span class="nc" id="L357">      pstmt.setString(2, employee.getPosition());</span>
<span class="nc" id="L358">      pstmt.setDouble(3, employee.getSalary());</span>
<span class="nc" id="L359">      pstmt.setDouble(4, employee.getPerformance());</span>
<span class="nc" id="L360">      pstmt.setInt(5, organizationId);</span>
<span class="nc" id="L361">      pstmt.setInt(6, internalEmployeeId);</span>

<span class="nc" id="L363">      int rowsAffected = pstmt.executeUpdate();</span>
<span class="nc bnc" id="L364" title="All 2 branches missed.">      return rowsAffected &gt; 0;</span>
<span class="nc" id="L365">    } catch (SQLException e) {</span>
<span class="nc" id="L366">      e.printStackTrace();</span>
<span class="nc" id="L367">      return false;</span>
    }
  }


  /**
   * Updates a department's information in the database.
   * This method handles all department updates including setting department head.
   *
   * @param organizationId the organization id
   * @param department the department to update
   * @return true if update successful, false otherwise
   */
  @Override
  public boolean updateDepartment(int organizationId, Department department) {
<span class="nc" id="L382">    int internalDepartmentId = organizationId * 10000 + department.getId();</span>
<span class="nc" id="L383">    Employee head = department.getHead();</span>
<span class="nc bnc" id="L384" title="All 2 branches missed.">    int headEmployeeId = head != null ? (organizationId * 10000 + head.getId()) : 0;</span>

<span class="nc bnc" id="L386" title="All 2 branches missed.">    if (head != null) {</span>
<span class="nc" id="L387">      String verifyQuery =</span>
              &quot;SELECT 1 FROM employees &quot;
                      + &quot;WHERE employee_id = ? AND organization_id = ? AND department_id = ?&quot;;

<span class="nc" id="L391">      try (PreparedStatement verifyStmt = connection.prepareStatement(verifyQuery)) {</span>
<span class="nc" id="L392">        verifyStmt.setInt(1, headEmployeeId);</span>
<span class="nc" id="L393">        verifyStmt.setInt(2, organizationId);</span>
<span class="nc" id="L394">        verifyStmt.setInt(3, internalDepartmentId);</span>

<span class="nc bnc" id="L396" title="All 2 branches missed.">        if (!verifyStmt.executeQuery().next()) {</span>
<span class="nc" id="L397">          return false;</span>
        }
<span class="nc bnc" id="L399" title="All 2 branches missed.">      } catch (SQLException e) {</span>
<span class="nc" id="L400">        e.printStackTrace();</span>
<span class="nc" id="L401">        return false;</span>
<span class="nc" id="L402">      }</span>
    }

<span class="nc" id="L405">    String query = &quot;UPDATE departments SET name = ?, head_employee_id = ? &quot;</span>
            + &quot;WHERE organization_id = ? AND department_id = ?&quot;;

<span class="nc" id="L408">    try (PreparedStatement pstmt = connection.prepareStatement(query)) {</span>
<span class="nc" id="L409">      pstmt.setString(1, department.getName());</span>
<span class="nc bnc" id="L410" title="All 2 branches missed.">      if (head != null) {</span>
<span class="nc" id="L411">        pstmt.setInt(2, headEmployeeId);</span>
      } else {
<span class="nc" id="L413">        pstmt.setNull(2, java.sql.Types.INTEGER);</span>
      }
<span class="nc" id="L415">      pstmt.setInt(3, organizationId);</span>
<span class="nc" id="L416">      pstmt.setInt(4, internalDepartmentId);</span>

<span class="nc" id="L418">      int rowsAffected = pstmt.executeUpdate();</span>
<span class="nc bnc" id="L419" title="All 2 branches missed.">      return rowsAffected &gt; 0;</span>
<span class="nc" id="L420">    } catch (SQLException e) {</span>
<span class="nc" id="L421">      e.printStackTrace();</span>
<span class="nc" id="L422">      return false;</span>
    }
  }

  @Override
  public boolean updateOrganization(Organization organization) {
<span class="nc" id="L428">    String query = &quot;UPDATE organizations SET name = ? WHERE organization_id = ?&quot;;</span>

<span class="nc" id="L430">    try (PreparedStatement pstmt = connection.prepareStatement(query)) {</span>
<span class="nc" id="L431">      pstmt.setString(1, organization.getName());</span>
<span class="nc" id="L432">      pstmt.setInt(2, organization.getId());</span>

<span class="nc" id="L434">      int rowsAffected = pstmt.executeUpdate();</span>
<span class="nc bnc" id="L435" title="All 2 branches missed.">      return rowsAffected &gt; 0;</span>
<span class="nc" id="L436">    } catch (SQLException e) {</span>
<span class="nc" id="L437">      e.printStackTrace();</span>
<span class="nc" id="L438">      return false;</span>
    }
  }

  @Override
  public Department insertDepartment(int organizationId, Department department) {
    // Generate a new internal department ID
<span class="nc" id="L445">    String maxIdQuery = &quot;SELECT MAX(department_id) as max_id FROM departments WHERE organization_id = ?&quot;;</span>
    int newDepartmentId;

<span class="nc" id="L448">    try (PreparedStatement pstmt = connection.prepareStatement(maxIdQuery)) {</span>
<span class="nc" id="L449">      pstmt.setInt(1, organizationId);</span>
<span class="nc" id="L450">      ResultSet rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L451" title="All 2 branches missed.">      if (rs.next()) {</span>
<span class="nc" id="L452">        int maxId = rs.getInt(&quot;max_id&quot;);</span>
<span class="nc bnc" id="L453" title="All 2 branches missed.">        if (rs.wasNull()) {</span>
<span class="nc" id="L454">          newDepartmentId = organizationId * 10000 + 1;</span>
        } else {
<span class="nc" id="L456">          newDepartmentId = maxId + 1;</span>
        }
<span class="nc" id="L458">      } else {</span>
<span class="nc" id="L459">        newDepartmentId = organizationId * 10000 + 1;</span>
      }
<span class="nc" id="L461">    } catch (SQLException e) {</span>
<span class="nc" id="L462">      e.printStackTrace();</span>
<span class="nc" id="L463">      return null;</span>
<span class="nc" id="L464">    }</span>

<span class="nc" id="L466">    String insertDepartmentQuery = &quot;INSERT INTO departments (department_id, organization_id, name) VALUES (?, ?, ?)&quot;;</span>

<span class="nc" id="L468">    try (PreparedStatement pstmt = connection.prepareStatement(insertDepartmentQuery)) {</span>
<span class="nc" id="L469">      pstmt.setInt(1, newDepartmentId);</span>
<span class="nc" id="L470">      pstmt.setInt(2, organizationId);</span>
<span class="nc" id="L471">      pstmt.setString(3, department.getName());</span>

<span class="nc" id="L473">      int rowsAffected = pstmt.executeUpdate();</span>
<span class="nc bnc" id="L474" title="All 2 branches missed.">      if (rowsAffected &gt; 0) {</span>
<span class="nc" id="L475">        int externalDeptId = newDepartmentId % 10000;</span>
<span class="nc" id="L476">        Department newDept = new Department(externalDeptId, department.getName(), new ArrayList&lt;&gt;());</span>
<span class="nc" id="L477">        return newDept;</span>
      }
<span class="nc bnc" id="L479" title="All 2 branches missed.">    } catch (SQLException e) {</span>
<span class="nc" id="L480">      e.printStackTrace();</span>
<span class="nc" id="L481">    }</span>
<span class="nc" id="L482">    return null;</span>
  }

  @Override
  public boolean removeDepartment(int organizationId, int externalDepartmentId) {
<span class="nc" id="L487">    int internalDepartmentId = organizationId * 10000 + externalDepartmentId;</span>

    // First, remove all employees in the department
<span class="nc" id="L490">    String deleteEmployeesQuery = &quot;DELETE FROM employees WHERE organization_id = ? AND department_id = ?&quot;;</span>
<span class="nc" id="L491">    try (PreparedStatement pstmt = connection.prepareStatement(deleteEmployeesQuery)) {</span>
<span class="nc" id="L492">      pstmt.setInt(1, organizationId);</span>
<span class="nc" id="L493">      pstmt.setInt(2, internalDepartmentId);</span>
<span class="nc" id="L494">      pstmt.executeUpdate();</span>
<span class="nc" id="L495">    } catch (SQLException e) {</span>
<span class="nc" id="L496">      e.printStackTrace();</span>
<span class="nc" id="L497">      return false;</span>
<span class="nc" id="L498">    }</span>

    // Then, remove the department
<span class="nc" id="L501">    String deleteDepartmentQuery = &quot;DELETE FROM departments WHERE organization_id = ? AND department_id = ?&quot;;</span>
<span class="nc" id="L502">    try (PreparedStatement pstmt = connection.prepareStatement(deleteDepartmentQuery)) {</span>
<span class="nc" id="L503">      pstmt.setInt(1, organizationId);</span>
<span class="nc" id="L504">      pstmt.setInt(2, internalDepartmentId);</span>

<span class="nc" id="L506">      int rowsAffected = pstmt.executeUpdate();</span>
<span class="nc bnc" id="L507" title="All 2 branches missed.">      return rowsAffected &gt; 0;</span>
<span class="nc" id="L508">    } catch (SQLException e) {</span>
<span class="nc" id="L509">      e.printStackTrace();</span>
<span class="nc" id="L510">      return false;</span>
    }
  }

  @Override
  public Organization insertOrganization(Organization organization) {
    // Generate a new organization ID
<span class="nc" id="L517">    String maxIdQuery = &quot;SELECT MAX(organization_id) as max_id FROM organizations&quot;;</span>
    int newOrganizationId;

<span class="nc" id="L520">    try (PreparedStatement pstmt = connection.prepareStatement(maxIdQuery)) {</span>
<span class="nc" id="L521">      ResultSet rs = pstmt.executeQuery();</span>
<span class="nc bnc" id="L522" title="All 2 branches missed.">      if (rs.next()) {</span>
<span class="nc" id="L523">        int maxId = rs.getInt(&quot;max_id&quot;);</span>
<span class="nc bnc" id="L524" title="All 2 branches missed.">        if (rs.wasNull()) {</span>
<span class="nc" id="L525">          newOrganizationId = 1;</span>
        } else {
<span class="nc" id="L527">          newOrganizationId = maxId + 1;</span>
        }
<span class="nc" id="L529">      } else {</span>
<span class="nc" id="L530">        newOrganizationId = 1;</span>
      }
<span class="nc" id="L532">    } catch (SQLException e) {</span>
<span class="nc" id="L533">      e.printStackTrace();</span>
<span class="nc" id="L534">      return null;</span>
<span class="nc" id="L535">    }</span>

<span class="nc" id="L537">    String insertOrganizationQuery = &quot;INSERT INTO organizations (organization_id, name) VALUES (?, ?)&quot;;</span>

<span class="nc" id="L539">    try (PreparedStatement pstmt = connection.prepareStatement(insertOrganizationQuery)) {</span>
<span class="nc" id="L540">      pstmt.setInt(1, newOrganizationId);</span>
<span class="nc" id="L541">      pstmt.setString(2, organization.getName());</span>

<span class="nc" id="L543">      int rowsAffected = pstmt.executeUpdate();</span>
<span class="nc bnc" id="L544" title="All 2 branches missed.">      if (rowsAffected &gt; 0) {</span>
<span class="nc" id="L545">        Organization newOrg = new Organization(newOrganizationId, organization.getName());</span>
<span class="nc" id="L546">        return newOrg;</span>
      }
<span class="nc bnc" id="L548" title="All 2 branches missed.">    } catch (SQLException e) {</span>
<span class="nc" id="L549">      e.printStackTrace();</span>
<span class="nc" id="L550">    }</span>
<span class="nc" id="L551">    return null;</span>
  }

  @Override
  public boolean removeOrganization(int organizationId) {
    // Delete employees
<span class="nc" id="L557">    String deleteEmployeesQuery = &quot;DELETE FROM employees WHERE organization_id = ?&quot;;</span>
<span class="nc" id="L558">    try (PreparedStatement pstmt = connection.prepareStatement(deleteEmployeesQuery)) {</span>
<span class="nc" id="L559">      pstmt.setInt(1, organizationId);</span>
<span class="nc" id="L560">      pstmt.executeUpdate();</span>
<span class="nc" id="L561">    } catch (SQLException e) {</span>
<span class="nc" id="L562">      e.printStackTrace();</span>
<span class="nc" id="L563">      return false;</span>
<span class="nc" id="L564">    }</span>

<span class="nc" id="L566">    String deleteDepartmentsQuery = &quot;DELETE FROM departments WHERE organization_id = ?&quot;;</span>
<span class="nc" id="L567">    try (PreparedStatement pstmt = connection.prepareStatement(deleteDepartmentsQuery)) {</span>
<span class="nc" id="L568">      pstmt.setInt(1, organizationId);</span>
<span class="nc" id="L569">      pstmt.executeUpdate();</span>
<span class="nc" id="L570">    } catch (SQLException e) {</span>
<span class="nc" id="L571">      e.printStackTrace();</span>
<span class="nc" id="L572">      return false;</span>
<span class="nc" id="L573">    }</span>

<span class="nc" id="L575">    String deleteOrganizationQuery = &quot;DELETE FROM organizations WHERE organization_id = ?&quot;;</span>
<span class="nc" id="L576">    try (PreparedStatement pstmt = connection.prepareStatement(deleteOrganizationQuery)) {</span>
<span class="nc" id="L577">      pstmt.setInt(1, organizationId);</span>

<span class="nc" id="L579">      int rowsAffected = pstmt.executeUpdate();</span>
<span class="nc bnc" id="L580" title="All 2 branches missed.">      return rowsAffected &gt; 0;</span>
<span class="nc" id="L581">    } catch (SQLException e) {</span>
<span class="nc" id="L582">      e.printStackTrace();</span>
<span class="nc" id="L583">      return false;</span>
    }
  }


  /**
   * Returns the unique instance of the database connection.
   * Designed with &quot;double-checked locking&quot; mechanism to ensure thread safety.
   *
   * @return the database connection instance
   */
  public static MysqlConnection getInstance() {
<span class="fc bfc" id="L595" title="All 2 branches covered.">    if (instance == null) {</span>
<span class="fc" id="L596">      synchronized (MysqlConnection.class) {</span>
<span class="pc bpc" id="L597" title="1 of 2 branches missed.">        if (instance == null) {</span>
<span class="fc" id="L598">          instance = new MysqlConnection();</span>
        }
<span class="fc" id="L600">      }</span>
    }
<span class="fc" id="L602">    return instance;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>